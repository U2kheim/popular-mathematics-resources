<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IMPACT Popular Mathematics Resource Library</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 20px; }
    .controls { margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    input[type="search"] { padding: 6px; min-width: 260px; }
    select, button, label { padding: 6px; }
    select[multiple] { min-width: 160px; max-width: 260px; height: 120px; }
    .filter-block { display:flex; flex-direction:column; font-size:90%; }
    .small { font-size:90%; color:#444; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f3f3f3; cursor: pointer; user-select: none; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    #count { margin-top: 6px; font-weight: 600; }
    @media (max-width: 800px) {
      .controls { flex-direction: column; align-items: stretch; }
      select[multiple] { height: 90px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>IMPACT Popular Mathematics Resource Library</h1>
  <p class="small">Edit <code>data/resources.csv</code> to update the table. For multi-value columns (e.g., Language, Theme), use <code>|</code> (pipe) between values: <code>English|Norsk|Svensk</code>.</p>

  <div class="controls" id="controls">
    <input id="search" type="search" placeholder="Search (title, description, topic...)" aria-label="Search">
    <label class="filter-block"><span class="small">Has link</span><input id="hasLink" type="checkbox"></label>
    <div class="filter-block">
      <span class="small">Sort by</span>
      <select id="sortBy"></select>
      <button id="toggleOrder" title="Toggle sort order">Asc</button>
    </div>
    <div id="dynamicFilters" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
    <div style="margin-left:auto"><button id="reset">Reset all</button></div>
  </div>

  <div id="count"></div>
  <table id="table" aria-live="polite">
    <thead><tr id="thead"></tr></thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
// Path to CSV in repo
const csvPath = 'data/resources.csv';

// Columns that may contain multiple values separated by '|'
// Edit these strings to match your CSV header names exactly
const multiValueColumns = ['Language','Theme','Medium']; // adjust as needed

let allRows = [], headers = [], filterableHeaders = [];
let sortOrderAsc = true;

// helper: returns array of tokens for a cell (split on '|' if column is configured)
function tokensForCell(columnName, cellValue) {
  if (!cellValue) return [];
  const val = cellValue.toString().trim();
  if (multiValueColumns.includes(columnName)) {
    return val.split('|').map(s => s.trim()).filter(s => s.length > 0);
  }
  return [val];
}

function renderTable(rows) {
  const thead = document.getElementById('thead'), tbody = document.getElementById('tbody');
  thead.innerHTML = ''; tbody.innerHTML = '';

  headers.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h;
    th.addEventListener('click', () => {
      document.getElementById('sortBy').value = h;
      const current = document.getElementById('sortBy').dataset.last;
      if (current === h) toggleOrder();
      document.getElementById('sortBy').dataset.last = h;
      applyFilters();
    });
    thead.appendChild(th);
  });

  rows.forEach(r => {
    const tr = document.createElement('tr');
    headers.forEach(h => {
      const td = document.createElement('td');
      const v = r[h] ?? '';
      const lower = h.toLowerCase();
      if ((lower.includes('link') || lower.includes('url')) && v) {
        const a = document.createElement('a');
        a.href = v;
        a.textContent = v;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        td.appendChild(a);
      } else {
        td.textContent = v;
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  document.getElementById('count').textContent = rows.length + ' result(s)';
}

function createFilters(rows) {
  const container = document.getElementById('dynamicFilters');
  container.innerHTML = '';
  filterableHeaders = headers.filter(h => {
    const lower = h.toLowerCase();
    return !['description','link','url'].includes(lower);
  });

  filterableHeaders.forEach((h, idx) => {
    const block = document.createElement('div');
    block.className = 'filter-block';
    const label = document.createElement('span'); label.className = 'small'; label.textContent = h;
    const sel = document.createElement('select');
    sel.multiple = true;
    sel.id = 'filter-' + idx;
    const set = new Set();
    rows.forEach(r => {
      const cell = r[h] || '';
      const tokens = tokensForCell(h, cell);
      tokens.forEach(t => { if (t) set.add(t); });
    });
    [...set].sort((a,b) => a.localeCompare(b, undefined, {sensitivity:'base'})).forEach(v => {
      const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o);
    });
    block.appendChild(label);
    block.appendChild(sel);
    container.appendChild(block);
  });

  const sortBy = document.getElementById('sortBy');
  sortBy.innerHTML = '';
  headers.forEach(h => { const o = document.createElement('option'); o.value = h; o.textContent = h; sortBy.appendChild(o); });
  sortBy.value = headers[0] || '';
  sortBy.dataset.last = '';
}

function getSelectedOptions(selectEl) {
  const out = [];
  if (!selectEl) return out;
  for (let i = 0; i < selectEl.options.length; i++) if (selectEl.options[i].selected) out.push(selectEl.options[i].value);
  return out;
}

function applyFilters() {
  const q = document.getElementById('search').value.trim().toLowerCase();
  const hasLink = document.getElementById('hasLink').checked;
  const selections = filterableHeaders.map((h, idx) => {
    const sel = document.getElementById('filter-' + idx);
    return getSelectedOptions(sel);
  });

  let filtered = allRows.filter(r => {
    if (hasLink) {
      const linkVal = (r['Link'] || r['URL'] || '').toString().trim();
      if (!linkVal) return false;
    }
    // column filters
    for (let i = 0; i < filterableHeaders.length; i++) {
      const h = filterableHeaders[i];
      const sel = selections[i];
      if (sel.length === 0) continue;
      const cell = r[h] || '';
      const tokens = tokensForCell(h, cell);
      // require that at least one selected value is present among tokens
      const matched = sel.some(s => tokens.includes(s));
      if (!matched) return false;
    }
    // free-text search across all columns (match anywhere, including multi-value tokens)
    if (q) {
      const hay = headers.map(h => (r[h] || '').toString().toLowerCase()).join(' ');
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  // sorting
  const sortBy = (document.getElementById('sortBy').value || '');
  if (sortBy) {
    filtered.sort((a,b) => {
      const A = (a[sortBy] || '').toString().toLowerCase();
      const B = (b[sortBy] || '').toString().toLowerCase();
      if (A < B) return sortOrderAsc ? -1 : 1;
      if (A > B) return sortOrderAsc ? 1 : -1;
      return 0;
    });
  }

  renderTable(filtered);
}

function toggleOrder() {
  sortOrderAsc = !sortOrderAsc;
  document.getElementById('toggleOrder').textContent = sortOrderAsc ? 'Asc' : 'Desc';
  applyFilters();
}

document.getElementById('search').addEventListener('input', applyFilters);
document.getElementById('hasLink').addEventListener('change', applyFilters);
document.getElementById('sortBy').addEventListener('change', applyFilters);
document.getElementById('toggleOrder').addEventListener('click', () => { toggleOrder(); });
document.getElementById('reset').addEventListener('click', () => {
  document.getElementById('search').value = '';
  document.getElementById('hasLink').checked = false;
  filterableHeaders.forEach((_, idx) => {
    const sel = document.getElementById('filter-' + idx);
    if (!sel) return;
    for (let i = 0; i < sel.options.length; i++) sel.options[i].selected = false;
  });
  document.getElementById('sortBy').value = headers[0] || '';
  sortOrderAsc = true; document.getElementById('toggleOrder').textContent = 'Asc';
  applyFilters();
});

// Fetch CSV text first to detect delimiter and then parse
fetch(csvPath)
  .then(resp => {
    if (!resp.ok) throw new Error('Could not fetch CSV (status ' + resp.status + ')');
    return resp.text();
  })
  .then(text => {
    const firstLine = text.split(/\r?\n/).find(l => l.trim().length > 0) || '';
    const semicolons = (firstLine.match(/;/g) || []).length;
    const commas = (firstLine.match(/,/g) || []).length;
    const delimiter = semicolons > commas ? ';' : ',';

    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      delimiter: delimiter,
      complete: function(results) {
        headers = results.meta.fields || [];
        allRows = results.data || [];
        createFilters(allRows);
        renderTable(allRows);
        applyFilters();
      },
      error: function(err) {
        document.getElementById('count').textContent = 'Error parsing CSV: ' + (err && err.message ? err.message : err);
      }
    });
  })
  .catch(err => {
    document.getElementById('count').textContent = 'Error loading CSV: ' + (err && err.message ? err.message : err);
  });
</script>
</body>
</html>
